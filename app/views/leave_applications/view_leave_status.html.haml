:css
  .nav-tabs>.active>a, .nav-tabs>.active>a:hover, .nav-tabs>.active>a:focus{
    background: -webkit-gradient( linear, left top, left bottom, from(#fff3db), to(rgba(0, 0, 0, 0.39)));
  }
  .leave_link{float: right;}
.alert-message
.leave_link
  =link_to "Apply Leave", new_user_leave_application_path(current_user)
%ul.leave_applicationTab.nav.nav-tabs
  %li.active
    %a#pending_link{data:{toggle: 'tab', leave_count: @pending_leaves.count}, href: '#pending_leave'}
      Pending (#{@pending_leaves.count})
  %li
    %a#leave_history_link{data:{toggle: "tab"}, href: '#processed_leave'}
      Leave History
   
.leave_application_tab_content.tab-content
  #processed_leave.tab-pane.fade
    = render 'leave_applications/leave_view', leave_data: @processed_leaves
  #pending_leave.tab-pane.fade.in.active
    = render 'leave_applications/leave_view', leave_data: @pending_leaves
:javascript
  var reject_reason = ''
  
  $('.reason').editable({
    validate: function(value){
      reject_reason = value
      update_leave($(this))
      show_spinner($(this))
    }
  });

  function approve_leave_event(){
    show_spinner($(this))
    update_leave($(this))
  }

  function cancel_leave_event(e){
    e.stopPropagation();
    $('.reason_' + $(this).attr('div_id')).editable('toggle')
  }

  $('.approve_leave').click(approve_leave_event)

  $('.cancel_leave').click(cancel_leave_event)

  function show_spinner(this_div){
    td = this_div.parent('td')
    action_div = td.parent().children('.action')
    spinner_div = td.parent().children('.spinner')
    action_div.hide()
    spinner_div.show()
  }

  function update_leave(option){
    leave_application_id = option.data('id');
    url = "/" + option.data('url');
    action = option.data('action');
 
    $.ajax({
      url: url,
      type: 'GET',
      data: {id: leave_application_id, action: action, reject_reason: reject_reason},
      success: function(value){
        console.log(value)
        // Detach row from pending list and append it to leave history
        // And just update status, reason and action button if request comes from history list
        tr_id = "#leave_application_" + leave_application_id;
        pending_leave = ($(tr_id).attr('pending') == 'true')

        row = pending_leave ? $(tr_id).detach() : $(tr_id)

        old_reason = ((row.children('td').children('.reason').html() == 'Empty') ? '' : row.children('td').children('.reason').html())

        if(action == 'cancel'){
          l_status = 'Rejected'
          message = 'Leave Cancelled'
          row.children('.action').html("<div class='approve_leave btn btn-mini btn-success' data-action='approve' data-id="+leave_application_id+" data-url='approve_leave_application' >Approve</div>") 
          $("div[data-id="+leave_application_id+"]").click(approve_leave_event)
          row.children('td').children('.prev_reason').append(old_reason + ';')
        }else{
          l_status = 'Approved'
          message = 'Leave Approved'
          row.children('.action').html("<div class='btn btn-danger btn-mini cancel_leave reject_btn' div_id="+ leave_application_id +">Reject</div>")
          $("div[div_id="+leave_application_id+"]").click(cancel_leave_event)
        }

        row.children('.action').show()
        row.children('.spinner').hide()
        row.children('.reason').html("<div class='reject_reason reject_reason_"+ leave_application_id + "editable editable-pre-wrapped editable-click data-action='cancel' data-id="+ leave_application_id +" data-type='textarea' data-url='cancel_leave_application' data-value=''></div>")
        row.children('.status').text(l_status)

        if(pending_leave){
          $('#processed_leave table tbody').append(row);
        }
        $('.alert-message').alert({txt: message, type: 'success'});  
        leave_count = $('#pending_link').data('leave-count') - 1
        ls = "Pending (" + leave_count + ")";
        $('#pending_link').text(ls);
        reject_reason = ''

      },
      error: function(e){
        $('.alert-message').alert({txt: 'Internal Server Error! Please contact web sysadmin', type: 'error'});  
      }
    });  
    return false;
  }
